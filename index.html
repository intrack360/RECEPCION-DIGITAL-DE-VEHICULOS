<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Recepci√≥n ¬∑ Intrack360</title>
<link rel="preconnect" href="https://fonts.gstatic.com">
<style>
  *{box-sizing:border-box}body{font-family:Arial,Helvetica,sans-serif;background:#f4f4f4;margin:0;padding:20px;}
  h1{text-align:center;color:#1976d2;margin-top:0}
  .card{background:#fff;padding:20px;margin:auto;max-width:760px;box-shadow:0 2px 5px rgba(0,0,0,.1);border-radius:8px}
  label{display:block;font-weight:bold;margin-top:12px}
  input,textarea{width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;margin-top:4px}
  input[readonly]{background:#e9e9e9}
  button{background:#1976d2;color:#fff;padding:10px 15px;border:none;border-radius:4px;cursor:pointer;margin-top:14px}
  button:hover{background:#135ba1}
  .legend{background:#e0f7fa;padding:10px;border-left:5px solid #00796b;border-radius:4px;margin-bottom:18px}
  .clauses{background:#f0f0f0;padding:15px;border-left:4px solid #1976d2;border-radius:5px;margin-top:16px}
  textarea{resize:vertical}
  canvas{border:1px solid #ccc;border-radius:4px;margin-top:6px}
</style>
</head>
<body>

<h1>üõ† Recepci√≥n ‚Äì Intrack360</h1>
<div class="card">
  <!-- Leyenda -->
  <div class="legend"><strong>Nota:</strong> Todos los campos son editables antes de firmar; solo se guardar√°n los conceptos seleccionados.</div>

  <!-- Datos cliente & veh√≠culo -->
  <label>Folio asignado</label><input id="folio" readonly>
  <label>Nombre del cliente</label><input id="nombreCliente" placeholder="Juan P√©rez">
  <label>Tel√©fono</label><input id="telefonoCliente" placeholder="3111234567">
  <label>Poblaci√≥n</label><input id="poblacionCliente" placeholder="Ciudad">

  <label>Placas</label><input id="placasVehiculo" placeholder="ABC1234" onblur="buscarPlacas()">
  <label>Marca</label><input id="marcaVehiculo" placeholder="Nissan">
  <label>Modelo</label><input id="modeloVehiculo" placeholder="Sentra">
  <label>A√±o</label><input id="anioVehiculo" placeholder="2015">
  <label>Motor</label><input id="motorVehiculo" placeholder="1.8L">
  <label>Cilindrada</label><input id="cilindradaVehiculo" placeholder="4 cilindros">

  <!-- Presupuesto / tiempo -->
  <label>Presupuesto estimado / Tiempo estimado de entrega</label>
  <input id="presupuesto" placeholder="$8 000 MXN / 3 d√≠as">

  <!-- Conceptos de trabajo (10 ejemplos, todos editables + check) -->
  <label>Conceptos de trabajo (selecciona y edita los que apliquen)</label>
  <div id="conceptos"></div>

  <!-- Observaciones -->
  <label>Observaciones</label>
  <textarea id="observaciones" rows="3" placeholder="Notas adicionales..."></textarea>

  <!-- Cl√°usulas -->
  <div class="clauses" id="bloqueClausulas">
    <textarea rows="3">1. El taller no se hace responsable por objetos no declarados al momento de la recepci√≥n.</textarea>
    <textarea rows="3">2. En caso de no aceptar el presupuesto, se cobrar√° diagn√≥stico.</textarea>
    <textarea rows="3">3. Pasadas 24 h de notificado el t√©rmino se cobrar√° pensi√≥n diaria de $50.00 MXN.</textarea>
  </div>

  <!-- Firma -->
  <label>Firma del cliente</label>
  <canvas id="firmaCanvas" width="550" height="120"></canvas>
  <button onclick="firmaPad.clear()">Borrar firma</button>

  <!-- Bot√≥n final -->
  <button onclick="generarPDF()">üìÑ Generar PDF y subir</button>
</div>

<!-- SDKs Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<!-- SignaturePad + jsPDF + html2canvas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/4.0.6/signature_pad.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* === TU configuraci√≥n Firebase === */
const firebaseConfig = {
  apiKey: "AIzaSyBJYNTP1IopR4bQo5q8D9mBGfp-CP3wPEc",
  authDomain: "intrack360.firebaseapp.com",
  projectId: "intrack360",
  storageBucket: "intrack360.appspot.com",
  messagingSenderId: "506102748165",
  appId: "1:506102748165:web:05b23e79ff04806881b86c"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();

/* === Generar folio consecutivo === */
async function generarFolio() {
  const q = db.collection('ordenesTrabajo').orderBy('folio','desc').limit(1);
  const snap = await q.get();
  let nuevo = 'TAL001-0001';
  if(!snap.empty){
    const ult = snap.docs[0].data().folio;
    const n   = parseInt(ult.split('-')[1])+1;
    nuevo = 'TAL001-'+n.toString().padStart(4,'0');
  }
  document.getElementById('folio').value = nuevo;
}
window.onload = () => {
  generarFolio();
  crearConceptos();
};

/* === Conceptos base por giro (10) === */
const conceptosBase = [
  "Cambio de aceite y filtro",
  "Diagn√≥stico de fallas de motor con esc√°ner",
  "Afinaci√≥n mayor",
  "Revisi√≥n de frenos",
  "Cambio de balatas",
  "Servicio de suspensi√≥n",
  "SINCRONIZACI√ìN DE DISTRIBUCI√ìN",
  "Lavado de inyectores",
  "Reemplazo de bater√≠a",
  "Revisi√≥n de sistema el√©ctrico"
];
function crearConceptos(){
  const ctn = document.getElementById('conceptos');
  conceptosBase.forEach(txt=>{
    const id = txt.toLowerCase().replace(/\s+/g,'_');
    ctn.insertAdjacentHTML('beforeend',
      `<label style="font-weight:normal">
         <input type="checkbox" id="chk_${id}"> 
         <input type="text" value="${txt}" id="txt_${id}" style="width:88%">
       </label>`
    );
  });
}

/* === Buscar por placas === */
async function buscarPlacas(){
  const placas = document.getElementById('placasVehiculo').value
                .trim().toUpperCase().replace(/[^A-Z0-9]/g,'');
  document.getElementById('placasVehiculo').value = placas;
  if(!placas) return;
  const snap = await db.collection('ordenesTrabajo')
                       .where('placas','==',placas).limit(1).get();
  if(!snap.empty){
    const d = snap.docs[0].data();
    document.getElementById('nombreCliente').value = d.nombreCliente;
    document.getElementById('telefonoCliente').value = d.telefonoCliente;
    document.getElementById('poblacionCliente').value = d.poblacionCliente;
    document.getElementById('marcaVehiculo').value = d.marcaVehiculo;
    document.getElementById('modeloVehiculo').value = d.modeloVehiculo;
    document.getElementById('anioVehiculo').value = d.anioVehiculo;
    document.getElementById('motorVehiculo').value = d.motorVehiculo;
    document.getElementById('cilindradaVehiculo').value = d.cilindradaVehiculo;
    alert('Datos cargados por placas.');
  }
}

/* === Firma digital === */
const firmaPad = new SignaturePad(document.getElementById('firmaCanvas'));

/* === Generar PDF, subir a Storage y registrar === */
async function generarPDF(){
  if(firmaPad.isEmpty()){ alert('Falta firma'); return; }

  const folio = document.getElementById('folio').value;

  /* Construir preview din√°mico */
  const preview = document.createElement('div');
  preview.style.padding = '20px';
  preview.innerHTML = document.querySelector('.card').innerHTML;
  /* inserta firma en preview */
  const img = new Image(); img.src = firmaPad.toDataURL(); img.style.width='150px';
  preview.appendChild(img);

  /* Convertir a canvas ‚Üí PDF */
  const canvas = await html2canvas(preview,{scale:2});
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p','pt','letter');
  pdf.addImage(canvas,'PNG',20,20,560,0);

  const blob = pdf.output('blob');

  /* Subir a Storage */
  const ref = storage.ref().child(`recepciones/${folio}.pdf`);
  await ref.put(blob);
  const url = await ref.getDownloadURL();

  /* Guardar datos orden */
  await db.collection('ordenesTrabajo').add({
    folio,
    nombreCliente: document.getElementById('nombreCliente').value,
    telefonoCliente: document.getElementById('telefonoCliente').value,
    poblacionCliente: document.getElementById('poblacionCliente').value,
    placas: document.getElementById('placasVehiculo').value,
    marcaVehiculo: document.getElementById('marcaVehiculo').value,
    modeloVehiculo: document.getElementById('modeloVehiculo').value,
    anioVehiculo: document.getElementById('anioVehiculo').value,
    motorVehiculo: document.getElementById('motorVehiculo').value,
    cilindradaVehiculo: document.getElementById('cilindradaVehiculo').value,
    presupuesto: document.getElementById('presupuesto').value,
    observaciones: document.getElementById('observaciones').value,
    pdfUrl: url,
    fechaFirma: new Date().toISOString()
  });

  alert('Contrato generado y subido ‚úîÔ∏è');

  /* === Enviar por WhatsApp (opcional) ===
  await sendWhatsApp(
      document.getElementById('telefonoCliente').value,
      document.getElementById('nombreCliente').value,
      folio,
      url
  );*/
  generarFolio(); // prepara la siguiente
}

/* === Cloud Function WhatsApp (comentado) === */
/*
async function sendWhatsApp(telefono,nombre,folio,link){
  await fetch('/send-whatsapp',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({to:`52${telefono}`,nombre,folio,link})
  });
}
*/
</script>
</body>
</html>
