<!DOCTYPE html><html lang="es"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Recepci√≥n ‚Äì Intrack360</title>
<link rel="icon" href="favicon.ico">
<style>
*{box-sizing:border-box}body{font-family:Arial,Helvetica,sans-serif;background:#f4f4f4;margin:0;padding:20px}
h1{color:#1976d2;text-align:center;margin-top:0}
.card{background:#fff;padding:22px;margin:auto;max-width:780px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.12)}
label{font-weight:bold;margin-top:12px;display:block}input,textarea{width:100%;padding:8px;margin-top:4px;border:1px solid #ccc;border-radius:4px}
input[readonly]{background:#e9e9e9}button{background:#1976d2;color:#fff;border:none;padding:12px 18px;border-radius:4px;cursor:pointer;margin-top:14px}
button:hover{background:#135ba1}.legend{background:#e0f7fa;padding:10px;border-left:5px solid #00796b;border-radius:4px;margin-bottom:18px}
textarea{resize:vertical}canvas{border:1px solid #ccc;border-radius:4px;margin-top:6px}
</style>
</head><body>
<h1>üõ† Recepci√≥n ‚Äì Intrack360</h1>
<div class="card">
  <div class="legend"><b>Nota:</b> edita conceptos y cl√°usulas; solo se guardar√° lo seleccionado.</div>

  <!-- Datos -->
  <label>Folio</label><input id="folio" readonly>
  <label>Cliente</label><input id="nombreCliente" placeholder="Juan P√©rez">
  <label>Tel√©fono</label><input id="telefonoCliente" placeholder="3111234567">
  <label>Poblaci√≥n</label><input id="poblacionCliente" placeholder="Ciudad">

  <!-- Veh√≠culo -->
  <label>Placas</label><input id="placas" placeholder="ABC1234" onblur="buscarPlacas()">
  <label>Marca</label><input id="marca">
  <label>Modelo</label><input id="modelo">
  <label>A√±o</label><input id="anio">
  <label>Motor</label><input id="motor">
  <label>Cilindrada</label><input id="cilindrada">

  <!-- Conceptos -->
  <label>Conceptos de trabajo</label>
  <div id="conceptos"></div>

  <label>Presupuesto / Tiempo estimado</label>
  <input id="presupuesto" placeholder="$8 000 MXN / 3 d√≠as">

  <label>Observaciones</label><textarea id="observaciones" rows="3"></textarea>

  <!-- Cl√°usulas -->
  <div id="clausulas" class="legend" style="background:#f0f0f0;border-left:4px solid #1976d2">
    <textarea rows="3">1. El taller no se hace responsable por objetos no declarados.</textarea>
    <textarea rows="3">2. Si no se acepta el presupuesto se cobrar√° diagn√≥stico.</textarea>
    <textarea rows="3">3. Pasadas 24 h de notificado, pensi√≥n de $50 MXN diarios.</textarea>
  </div>

  <!-- Firma -->
  <label>Firma del cliente</label>
  <canvas id="firma" width="560" height="140"></canvas><br>
  <button onclick="pad.clear()">Borrar firma</button>

  <!-- Final -->
  <button onclick="generarPDF()">üìÑ Generar PDF y subir</button>
</div>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<!-- librer√≠as -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/4.0.6/signature_pad.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* === 1. Configura con TU proyecto === */
const firebaseConfig={apiKey:"TU_API_KEY",authDomain:"tu-proyecto.firebaseapp.com",projectId:"tu-proyecto",
storageBucket:"tu-proyecto.appspot.com",messagingSenderId:"*********",appId:"1:*********:web:**********"};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore(),st=firebase.storage();

/* === 2. Conceptos demo === */
const base=["Cambio de aceite","Diagn√≥stico de motor con esc√°ner","Afinaci√≥n mayor","Revisi√≥n de frenos",
"Servicio de suspensi√≥n","Sincronizaci√≥n de distribuci√≥n","Lavado de inyectores","Reemplazo de bater√≠a",
"Revisi√≥n el√©ctrica","Reparaci√≥n de clima"];
base.forEach(t=>{
  const id=t.toLowerCase().replace(/\s+/g,'_');
  document.getElementById('conceptos').insertAdjacentHTML('beforeend',
  `<label style="font-weight:normal"><input type="checkbox" id="c_${id}"> 
   <input type="text" id="t_${id}" value="${t}" style="width:85%"></label>`);});

/* === 3. Firma === */
const pad=new SignaturePad(document.getElementById('firma'));

/* === 4. Folio autoincremental === */
async function folioNuevo(){
 const s=await db.collection('ordenesTrabajo').orderBy('folio','desc').limit(1).get();
 let f='TAL001-0001';
 if(!s.empty){const n=parseInt(s.docs[0].data().folio.split('-')[1])+1;f='TAL001-'+String(n).padStart(4,'0');}
 document.getElementById('folio').value=f;}
window.onload=folioNuevo;

/* === 5. Buscar por placas === */
async function buscarPlacas(){
 const p=document.getElementById('placas').value.trim().toUpperCase().replace(/[^A-Z0-9]/g,'');
 document.getElementById('placas').value=p;if(!p)return;
 const q=await db.collection('ordenesTrabajo').where('placas','==',p).limit(1).get();
 if(!q.empty){const d=q.docs[0].data();["nombreCliente","telefonoCliente","poblacionCliente",
 "marca","modelo","anio","motor","cilindrada"].forEach(k=>{if(d[k])document.getElementById(k).value=d[k];});
 alert('Datos cargados por placa');}}
 
/* === 6. Generar PDF y subir === */
async function generarPDF(){
 if(pad.isEmpty()){alert('Falta firma');return;}
 const folio=document.getElementById('folio').value;

 // previsualizaci√≥n
 const prev=document.createElement('div');prev.style.padding='20px';
 prev.innerHTML=document.querySelector('.card').innerHTML;
 const img=new Image();img.src=pad.toDataURL();img.style.width='160px';prev.appendChild(img);
 prev.style.position='fixed';prev.style.left='-9999px';document.body.appendChild(prev);

 const cvs=await html2canvas(prev,{scale:2});document.body.removeChild(prev);
 const {jsPDF}=window.jspdf;const pdf=new jsPDF('p','pt','letter');
 pdf.addImage(cvs,'PNG',20,20,560,0);const blob=pdf.output('blob');

 const ref=st.ref().child(`recepciones/${folio}.pdf`);await ref.put(blob);
 const url=await ref.getDownloadURL();

 // selecciona conceptos marcados
 const seleccion=base.filter(t=>{
   const id=t.toLowerCase().replace(/\\s+/g,'_');
   return document.getElementById('c_'+id).checked;});

 await db.collection('ordenesTrabajo').add({
   folio,
   nombreCliente:document.getElementById('nombreCliente').value,
   telefonoCliente:document.getElementById('telefonoCliente').value,
   poblacionCliente:document.getElementById('poblacionCliente').value,
   placas:document.getElementById('placas').value,
   marca:document.getElementById('marca').value,
   modelo:document.getElementById('modelo').value,
   anio:document.getElementById('anio').value,
   motor:document.getElementById('motor').value,
   cilindrada:document.getElementById('cilindrada').value,
   presupuesto:document.getElementById('presupuesto').value,
   observaciones:document.getElementById('observaciones').value,
   conceptos:seleccion,
   pdfUrl:url,
   fechaFirma:new Date().toISOString()
 });
 alert('PDF subido y orden guardada ‚úîÔ∏è');folioNuevo();pad.clear();
 /* === Para WhatsApp descomenta la l√≠nea siguiente y configura tu funci√≥n === */
 // await sendWhatsApp(document.getElementById('telefonoCliente').value,folio,url);
}

/* === 7. (Opc) WhatsApp Cloud Function ===
async function sendWhatsApp(tel,folio,link){
 await fetch('/send-whatsapp',{method:'POST',headers:{'Content-Type':'application/json'},
 body:JSON.stringify({to:`52${tel}`,folio,link})});
}*/
</script>
</body></html>
